<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RushitTunes</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Styles omitted for brevity, same as before */
    </style>
</head>
<body>
    <div class="container">
        <h1>RushitTunes</h1>
        <p>Your personal music streaming platform</p>

        <form id="searchForm" class="search-form">
            <input type="text" id="query" placeholder="Search for a song..." required>
            <button id="searchButton" type="submit" aria-label="Search">
                <i class="fas fa-search"></i>
            </button>
        </form>
        <p id="loading" class="loading">Ready to search</p>

        <div id="playerContainer" class="player-container">
            <p id="songTitle" class="song-title">No song playing</p>
            <button id="playPauseButton" class="play-pause-button" aria-label="Play/Pause">
                <i id="playPauseIcon" class="fas fa-play"></i>
            </button>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('searchForm');
        const loadingIndicator = document.getElementById('loading');
        const songTitle = document.getElementById('songTitle');
        const audioPlayer = new Audio();
        const progressBar = document.getElementById('progress');
        const progressContainer = document.querySelector('.progress-bar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = document.getElementById('playPauseIcon');

        let currentSearchResults = [];
        let currentSongIndex = 0;

        // Handle song search
        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            const query = document.getElementById('query').value.trim();

            if (!query) {
                alert('Please enter a valid search term.');
                return;
            }

            loadingIndicator.textContent = `Searching for "${query}"...`;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query }),
                });

                const data = await response.json();

                if (data.error) {
                    loadingIndicator.textContent = 'Error occurred during search';
                    alert(`Error: ${data.error}`);
                    return;
                }

                currentSearchResults = data.audio_urls;
                if (currentSearchResults.length === 0) {
                    loadingIndicator.textContent = 'No results found';
                    return;
                }

                currentSongIndex = 0;
                playSong(currentSongIndex);
                loadingIndicator.textContent = '';
            } catch (error) {
                loadingIndicator.textContent = 'Error occurred during search';
                alert(`Failed to fetch songs: ${error}`);
            }
        });

        // Play a specific song from the results
        function playSong(index) {
            if (index < 0 || index >= currentSearchResults.length) {
                return;
            }

            const songUrl = currentSearchResults[index];
            audioPlayer.src = songUrl;
            audioPlayer.play();
            playPauseIcon.className = 'fas fa-pause';
            songTitle.textContent = `Playing song ${index + 1} of ${currentSearchResults.length}`;

            audioPlayer.onended = () => {
                currentSongIndex++;
                if (currentSongIndex < currentSearchResults.length) {
                    playSong(currentSongIndex);
                } else {
                    playPauseIcon.className = 'fas fa-play';
                    songTitle.textContent = 'Playback finished';
                }
            };
        }

        // Play/Pause toggle
        playPauseButton.addEventListener('click', function () {
            if (!audioPlayer.src) {
                alert('No song is loaded. Please search for a song first.');
                return;
            }

            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseIcon.className = 'fas fa-pause';
            } else {
                audioPlayer.pause();
                playPauseIcon.className = 'fas fa-play';
            }
        });

        // Update progress bar and time
        audioPlayer.addEventListener('timeupdate', function () {
            const currentTime = audioPlayer.currentTime || 0;
            const duration = audioPlayer.duration || 0;

            if (!isNaN(duration)) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = progressPercent + '%';
            }

            const formatTime = time => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            };

            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        });

        // Click to seek in the progress bar
        progressContainer.addEventListener('click', function (event) {
            const width = progressContainer.clientWidth;
            const clickX = event.offsetX;
            const duration = audioPlayer.duration || 0;

            if (!isNaN(duration)) {
                const newTime = (clickX / width) * duration;
                audioPlayer.currentTime = newTime;
            }
        });
    </script>
</body>
</html>
